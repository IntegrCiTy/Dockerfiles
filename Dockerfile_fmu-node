FROM continuumio/miniconda3

USER root

# Install OBNL ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

# ImportError: libgfortran.so.3
RUN apt-get install -y libgfortran3
# https://github.com/ContinuumIO/anaconda-issues/issues/686 ?

RUN conda create --name ict-env python=3.5

RUN /bin/bash -c "source activate ict-env && conda install -y -c chria pyfmi=2.4"
RUN /bin/bash -c "source activate ict-env && pip install --ignore-installed -U setuptools"

RUN git clone -b feature/logging https://github.com/IntegrCiTy/obnl.git
WORKDIR obnl

RUN /bin/bash -c "source activate ict-env && pip install --no-cache-dir -r requirements.txt"

RUN /bin/bash -c "source activate ict-env && python setup.py install"

ENV PATH /opt/conda/envs/ict-env/bin:$PATH

# Configure environment ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
ENV SHELL=/bin/bash \
    NB_USER=ictuser \
    NB_UID=1000 \
    NB_GID=100

ENV HOME=/home/$NB_USER

ADD fix-permissions /usr/local/bin/fix-permissions
RUN chmod +x /usr/local/bin/fix-permissions

RUN useradd -m -s /bin/bash -N -u $NB_UID $NB_USER && \
	fix-permissions $HOME

USER $NB_USER

# Setup work directory for backward-compatibility
RUN mkdir /home/$NB_USER/work && \
	fix-permissions /home/$NB_USER

WORKDIR $HOME/work

ENTRYPOINT ["python"]

# docker run -it --rm -v $(pwd):/home/ictuser/work integrcity/node <ICT_FILE.py> <IP_RABBIT> 
